server {
    listen 80;
    server_name _;

    # Increase buffer sizes for large headers (JWT tokens)
    proxy_buffer_size 128k;
    proxy_buffers 4 256k;
    large_client_header_buffers 4 32k;

    # Max upload size (for file uploads in Dify)
    client_max_body_size 100m;

    # Timeouts
    proxy_connect_timeout 60s;
    proxy_send_timeout 120s;
    proxy_read_timeout 120s;

    # Common proxy headers
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto https;

    # SSE support (for streaming responses)
    proxy_http_version 1.1;
    proxy_set_header Connection "";

    # ===== PORTAL - Landing Page with App Switcher =====

    location = / {
        default_type text/html;
        return 200 '<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Platform Portal</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:system-ui,-apple-system,sans-serif;background:#0a0a0a;color:#e2e8f0;min-height:100vh;display:flex;flex-direction:column;align-items:center;padding:40px 20px}
h1{font-size:2.5rem;font-weight:700;background:linear-gradient(135deg,#38bdf8,#818cf8,#c084fc);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:8px}
.subtitle{color:#94a3b8;font-size:1.1rem;margin-bottom:48px}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;max-width:1200px;width:100%}
.card{background:#111827;border:1px solid #1e293b;border-radius:16px;padding:28px;transition:all .2s;cursor:pointer;text-decoration:none;color:#e2e8f0;position:relative;overflow:hidden}
.card:hover{border-color:#38bdf8;transform:translateY(-2px);box-shadow:0 8px 30px rgba(56,189,248,.15)}
.card-icon{font-size:2rem;margin-bottom:12px}
.card h3{font-size:1.2rem;font-weight:600;margin-bottom:8px}
.card p{color:#94a3b8;font-size:.9rem;line-height:1.5}
.badge{position:absolute;top:16px;right:16px;padding:4px 10px;border-radius:20px;font-size:.7rem;font-weight:600;text-transform:uppercase}
.live{background:#065f46;color:#34d399}
.soon{background:#78350f;color:#fbbf24}
.section{color:#64748b;font-size:.8rem;font-weight:600;letter-spacing:.1em;text-transform:uppercase;margin:32px 0 16px;width:100%;max-width:1200px}
</style>
</head>
<body>
<h1>AI Platform</h1>
<p class="subtitle">Dify + Lyzr + CrewAI - Unified AI Workspace</p>

<div class="section">Hauptanwendungen</div>
<div class="grid">
<a href="/dify/" class="card"><span class="badge live">Live</span><div class="card-icon">&#x1f916;</div><h3>Dify</h3><p>LLM App Builder - Workflows, RAG, Chatbots, Agent Tools</p></a>
<a href="/search/" class="card"><span class="badge live">Live</span><div class="card-icon">&#x1f50d;</div><h3>Lyzr Search</h3><p>Perplexity-Style AI Search mit SearXNG Backend</p></a>
<a href="/governance/" class="card"><span class="badge live">Live</span><div class="card-icon">&#x1f6e1;</div><h3>Lyzr Governor</h3><p>AI Governance Dashboard - Policies, Approvals, Compliance</p></a>
</div>

<div class="section">Tools & APIs</div>
<div class="grid">
<a href="/crawl/swagger/index.html" class="card"><span class="badge live">Live</span><div class="card-icon">&#x1f577;</div><h3>Lyzr Crawl</h3><p>Web Crawler API - Scraping, Content Extraction</p></a>
<a href="/simulate/" class="card"><span class="badge live">Live</span><div class="card-icon">&#x1f9ea;</div><h3>Agent Simulator</h3><p>Agent Simulation Engine - Testing & Evaluation</p></a>
<a href="/skills/" class="card"><span class="badge live">Live</span><div class="card-icon">&#x1f9f0;</div><h3>Skills & Kit</h3><p>Lyzr Skills Adapters + Agent Management CLI</p></a>
</div>

<div class="section">Agent Frameworks</div>
<div class="grid">
<a href="/crewai/" class="card"><span class="badge live">Live</span><div class="card-icon">&#x1f465;</div><h3>CrewAI Studio</h3><p>Multi-Agent Teams - Visuelle Erstellung, Management & Ausfuehrung</p></a>
<a href="#" class="card" style="opacity:.6"><span class="badge soon">Planned</span><div class="card-icon">&#x1f310;</div><h3>LangGraph</h3><p>State-Machine Workflows fuer komplexe Agent-Pipelines</p></a>
</div>
</body></html>';
    }

    # ===== Dify API routes -> Api service (port 5001) =====

    location /console/api/ {
        proxy_pass http://${API_HOST}:${API_PORT}/console/api/;
    }

    location /api/ {
        proxy_pass http://${API_HOST}:${API_PORT}/api/;
    }

    location /v1/ {
        proxy_pass http://${API_HOST}:${API_PORT}/v1/;
    }

    location /files/ {
        proxy_pass http://${API_HOST}:${API_PORT}/files/;
    }

    # ===== Dify Web -> Web service (port 3000) =====

    location /dify/ {
        proxy_pass http://${WEB_HOST}:${WEB_PORT}/;
    }

    # ===== Lyzr Perplexity Search -> Frontend (port 3000) + Backend (port 8000) =====

    location /search/api/ {
        proxy_pass http://${PERPLEXITY_BACKEND_HOST}:${PERPLEXITY_BACKEND_PORT}/;
    }

    location /search/ {
        proxy_pass http://${PERPLEXITY_FRONTEND_HOST}:${PERPLEXITY_FRONTEND_PORT}/;
    }

    # ===== Lyzr Governor Dashboard (port 8765) =====

    location /governance/ {
        proxy_pass http://${GOVERNOR_HOST}:${GOVERNOR_PORT}/;
    }

    location /governance/ws {
        proxy_pass http://${GOVERNOR_HOST}:${GOVERNOR_PORT}/ws;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # ===== Lyzr Crawl API (port 8080) =====

    location /crawl/ {
        proxy_pass http://${CRAWL_HOST}:${CRAWL_PORT}/;
    }

    # ===== Agent Simulation Engine (port 8000) =====

    location /simulate/ {
        proxy_pass http://${SIMULATION_HOST}:${SIMULATION_PORT}/;
    }

    # ===== Lyzr Skills + Kit (port 8000) =====

    location /skills/ {
        proxy_pass http://${SKILLS_HOST}:${SKILLS_PORT}/;
    }

    # ===== CrewAI Studio (port 8501) =====

    location /crewai/ {
        proxy_pass http://${CREWAI_HOST}:${CREWAI_PORT}/;
    }

    location /crewai/_stcore/ {
        proxy_pass http://${CREWAI_HOST}:${CREWAI_PORT}/_stcore/;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
